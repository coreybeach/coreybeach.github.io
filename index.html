<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cruise Master Plan</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2e;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#a6b0c3;
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      /* Tag colors */
      --c-booked: #10b981;
      --c-booked-bg: rgba(16,185,129,.18);
      --c-booked-br: rgba(16,185,129,.35);

      --c-flex: #f59e0b;
      --c-flex-bg: rgba(245,158,11,.20);
      --c-flex-br: rgba(245,158,11,.35);

      --c-pri: #ef4444;       /* RED priority */
      --c-pri-bg: rgba(239,68,68,.18);
      --c-pri-br: rgba(239,68,68,.35);

      --c-risk: #fb7185;
      --c-risk-bg: rgba(244,63,94,.18);
      --c-risk-br: rgba(244,63,94,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(52,211,153,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.72);
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto; padding:12px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand .title{font-weight:800; letter-spacing:.2px}
    .brand .sub{color:var(--muted); font-size:12px}
    .nav{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .pilllink{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,46,.65);
      font-size:13px;
      transition:.15s transform ease, .15s background ease;
      white-space:nowrap;
      color:inherit; text-decoration:none;
    }
    .pilllink:hover{background: rgba(16,26,46,.9)}
    .pilllink:active{transform:scale(.98)}
    .pilllink.accent{border-color: rgba(96,165,250,.35)}

    .wrap{max-width:1100px; margin:0 auto; padding:16px 14px 70px;}
    section{margin-top:18px}
    .section-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin:8px 0 10px;
    }
    h2{margin:0; font-size:18px; letter-spacing:.2px}
    .note{color:var(--muted); font-size:12px}

    .card{
      background: linear-gradient(180deg, rgba(16,26,46,.92), rgba(15,23,42,.92));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
    }
    .card h3{margin:0 0 10px; font-size:15px;}

    .daybar{
      display:flex; gap:8px; overflow:auto; padding-bottom:6px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .daybar::-webkit-scrollbar{display:none}
    .daybtn{
      flex: 0 0 auto;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(16,26,46,.75);
      color: #ffffff;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition: background .15s ease, transform .15s ease, box-shadow .15s ease;
    }
    .daybtn:hover{background: rgba(16,26,46,.95);}
    .daybtn:active{transform: scale(.97);}
    .daybtn.active{
      background: linear-gradient(180deg, rgba(96,165,250,.35), rgba(59,130,246,.35));
      border-color: rgba(96,165,250,.6);
      box-shadow: 0 0 0 2px rgba(96,165,250,.25) inset;
    }
    .daypanel{display:none}
    .daypanel.active{display:block}

    .kv{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px; margin-top:10px;}
    .chip{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }

    .filters{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,46,.65);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .toggle input{accent-color:#60a5fa}
    .toggle small{color:var(--muted)}

    .list{margin:10px 0 0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px;}
    .li{padding:10px 10px; border-radius: 12px; background: rgba(255,255,255,.03); border:1px solid var(--border);}
    .li .when{font-family:var(--mono); color:#cdd6e7; font-size:12px}
    .li .what{margin-top:2px}
    .small{font-size:12px; color: var(--muted)}
    .muted{color:var(--muted)}

    .warn{margin-top:8px; display:flex; flex-direction:column; gap:6px}
    .warnline{
      font-size:12px;
      color:#fca5a5;
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.25);
      border-radius: 10px;
      padding:6px 8px;
    }

    /* Tag pills */
    .eventtags{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
    .tagpill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      white-space:nowrap;
      font-weight:800;
    }
    .tagpill.locked{ background: var(--c-booked-bg); color: var(--c-booked); border-color: var(--c-booked-br); }
    .tagpill.flex{ background: var(--c-flex-bg); color: var(--c-flex); border-color: var(--c-flex-br); }
    .tagpill.priority{ background: var(--c-pri-bg); color: var(--c-pri); border-color: var(--c-pri-br); }
    .tagpill.risk{ background: var(--c-risk-bg); color: var(--c-risk); border-color: var(--c-risk-br); }

    /* Tables */
    .table-wrap{
      overflow:auto;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(16,26,46,.55);
      margin-top:10px;
    }
    table{ width:100%; border-collapse:collapse; min-width:980px; }
    th, td{
      border-bottom:1px solid var(--border);
      border-right:1px solid var(--border);
      padding:10px 10px;
      vertical-align: top;
      font-size:13px;
    }
    th{
      position:sticky; top:0;
      background: rgba(11,18,32,.95);
      z-index:1;
      text-align:left;
      font-size:12px;
      letter-spacing:.2px;
      color: var(--muted);
    }
    td:first-child, th:first-child{
      position:sticky; left:0;
      background: rgba(11,18,32,.95);
      z-index:2;
      font-family: var(--mono);
      font-size:12px;
      color:#cdd6e7;
      width:140px;
    }
    tr:last-child td{border-bottom:none}
    td:last-child, th:last-child{border-right:none}

    .colhead-title{font-weight:800; color:#e5e7eb; font-size:13px; margin-bottom:4px}
    .colhead-sub{font-size:12px; color:var(--muted)}

    td .eventline{margin:0 0 12px}
    td .eventline:last-child{margin-bottom:0}
    td .eventtitle{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    td .eventtitle strong{font-weight:750}
    td .eventmeta{margin-top:3px}
    .cell-muted{color: var(--muted)}

    .footer{margin-top:18px; color: var(--muted); font-size:12px; text-align:center;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="title">üõ≥Ô∏è Cruise Master Plan</div>
        <div class="sub" id="subtitle">All times = ship time ‚Ä¢ Offline-friendly</div>
      </div>
      <nav class="nav">
        <a class="pilllink accent" href="#today">Today</a>
        <a class="pilllink" href="#grid">Grids</a>
        <a class="pilllink" href="#days">Days</a>
      </nav>
    </div>
  </div>

  <div class="wrap">
    <section id="today">
      <div class="section-head">
        <h2>üìå Today (tap a day below)</h2>
        <div class="note">Simple, mobile-first. Grids below for planning.</div>
      </div>

      <div class="card">
        <div class="daybar" id="daybar"></div>

        <div class="filters" id="filters"></div>

        <div class="timeline" id="todayPanel"></div>
      </div>
    </section>

    <section id="grid">
      <div class="section-head">
        <h2>üóìÔ∏è Visual grids</h2>
        <div class="note">No header at-a-glance duplication ‚Ä¢ Dining shown once per day in evening grid</div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:6px;">üåÖ Morning / Port grid</h3>
        <div class="note">Shows only: Port / Excursions / Logistics (meet/ready buffers)</div>
        <div class="table-wrap" id="gridTableMorning"></div>

        <h3 style="margin:16px 0 6px;">üåô Evening / Shows grid</h3>
        <div class="note">Shows: Dining Window row + Entertainment</div>
        <div class="table-wrap" id="gridTableEvening"></div>
      </div>
    </section>

    <section id="days">
      <div class="section-head">
        <h2>üìÖ Full day-by-day</h2>
        <div class="note">Includes conflict + walk-time warnings (toggleable)</div>
      </div>
      <div id="allDays" style="display:grid; grid-template-columns:1fr; gap:12px;"></div>
    </section>

    <div class="footer">
      iPhone Safari ‚Üí Share ‚Üí ‚ÄúAdd to Home Screen‚Äù. Android Chrome ‚Üí Menu ‚Üí ‚ÄúAdd to Home screen‚Äù.
    </div>
  </div>

  <script>
    /*****************************************************************
     * DATA (edit here)
     *****************************************************************/
    const CRUISE_DATA = {
      meta: {
        subtitle: "All times = ship time ‚Ä¢ Offline-friendly",
        days: [
          { id:"d1", label:"Day 1", title:"Miami / Sail Away" },
          { id:"d2", label:"Day 2", title:"Sea Day" },
          { id:"d3", label:"Day 3", title:"Puerto Costa Maya (8:00‚Äì5:00)" },
          { id:"d4", label:"Day 4", title:"Roat√°n (7:00‚Äì4:00)" },
          { id:"d5", label:"Day 5", title:"Cozumel (8:00‚Äì6:00)" },
          { id:"d6", label:"Day 6", title:"Sea Day" },
          { id:"d7", label:"Day 7", title:"CocoCay (7:00‚Äì5:00)" }
        ]
      },

      gridSlotsMorning: [
        { label:"7:00‚Äì8:30",   start:"07:00", end:"08:30" },
        { label:"8:30‚Äì10:00",  start:"08:30", end:"10:00" },
        { label:"10:00‚Äì11:30", start:"10:00", end:"11:30" },
        { label:"11:30‚Äì1:00",  start:"11:30", end:"13:00" },
        { label:"1:00‚Äì3:00",   start:"13:00", end:"15:00" },
        { label:"3:00‚Äì4:30",   start:"15:00", end:"16:30" }
      ],

      // Evening grid includes a dedicated Dining row at the top
      gridSlotsEvening: [
        { label:"üçΩÔ∏è Dining Window", start:"DINING", end:"DINING" }, /* special row */
        { label:"4:30‚Äì6:00",   start:"16:30", end:"18:00" },
        { label:"6:00‚Äì7:30",   start:"18:00", end:"19:30" },
        { label:"7:30‚Äì9:00",   start:"19:30", end:"21:00" },
        { label:"9:00‚Äì10:30",  start:"21:00", end:"22:30" },
        { label:"10:30‚Äì12:00", start:"22:30", end:"24:00" },
        { label:"12:00‚ÄìLate",  start:"24:00", end:null }
      ],

      days: {
        d1: {
          chips: ["üìç Miami ‚Üí Sail Away", "üßØ Safety briefing required"],
          events: [
            { start:"16:30", end:"17:00", title:"üéâ Sail Away Party", venue:"Pool Deck (D16)", category:"entertainment" },
            { start:"18:30", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["flex"], category:"dining" },
            { start:"21:30", end:"22:20", title:"üé≠ Headliner", venue:"Royal Theater (D4 Fwd)", category:"entertainment" },
            { start:"23:50", end:"24:00", title:"üé∂ Big Welcome Sing-Along", venue:"Royal Promenade (D5 Mid)", category:"entertainment" },
            { start:"24:00", end:null, grid_mins:90, title:"üéâ Balloon Drop + After Hours DJ", venue:"Promenade (D5 Mid) / Music Hall (D3 Fwd)", category:"entertainment" }
          ]
        },

        d2: {
          chips: ["üåä Sea Day"],
          events: [
            { start:"18:45", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["locked"], category:"dining" },
            { start:"23:30", end:"24:25", title:"üé§ Adult Comedy (18+)", venue:"The Attic (D6 Fwd)", category:"entertainment" }
          ]
        },

        d3: {
          chips: ["üèùÔ∏è Puerto Costa Maya (8:00‚Äì5:00)", "‚ö†Ô∏è Late night risk"],
          events: [
            { start:"08:00", end:"17:00", title:"üèùÔ∏è Port day (explore)", category:"port" },
            { start:"16:30", end:"18:10", title:"üé≠ The Wizard of Oz", venue:"Royal Theater (D4 Fwd)", category:"entertainment" },
            { start:"19:00", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["flex"], category:"dining" },
            { start:"23:30", end:"24:25", title:"üé§ Adult Comedy (18+)", venue:"The Attic (D6 Fwd)", tags:["risk"], category:"entertainment" }
          ]
        },

        d4: {
          chips: ["üèùÔ∏è Roat√°n (7:00‚Äì4:00)", "üßó Zipline 9:00 (meet ~8:30)"],
          events: [
            { start:"08:30", end:null, grid_mins:30, title:"‚è±Ô∏è Meet buffer (excursion)", tags:["priority"], category:"logistics" },
            { start:"09:00", end:null, grid_mins:180, title:"üßó Zip & Dip (Excursion)", venue:"Port of Roat√°n", tags:["priority"], category:"excursion" },
            { start:"18:45", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["locked"], category:"dining" },
            { start:"21:00", end:"22:00", title:"üéÆ Game Show: Love & Marriage", venue:"Royal Theater (D4 Fwd)", tags:["priority"], category:"entertainment" }
          ]
        },

        d5: {
          chips: ["üèùÔ∏è Cozumel (8:00‚Äì6:00)", "üõû ATV 10:00 (ready ~9:30)", "üçΩÔ∏è Booked dining 8:30"],
          events: [
            { start:"09:30", end:null, grid_mins:30, title:"‚è±Ô∏è Ready buffer (excursion)", tags:["priority"], category:"logistics" },
            { start:"10:00", end:null, grid_mins:240, title:"üõû ATV Ride to Jade Caverns (Excursion)", venue:"Cozumel", tags:["priority"], category:"excursion" },
            { start:"19:00", end:"20:00", title:"üéÆ Price Is Right ‚Äì Everyone‚Äôs a Contestant", venue:"Royal Theater (D4 Fwd)", tags:["priority"], category:"entertainment" },
            { start:"20:30", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["locked"], category:"dining" },
            { start:"23:00", end:"23:45", title:"üéÆ The Crazy Quest (18+)", venue:"Absolute Zero (D6 Aft)", tags:["priority"], category:"entertainment" }
          ]
        },

        d6: {
          chips: ["üåä Sea Day"],
          events: [
            { start:"18:30", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["flex"], category:"dining" },
            { start:"22:30", end:"23:30", title:"üí¶ AQUA ACTION!", venue:"AquaTheater (D15 Fwd)", tags:["locked"], category:"entertainment" }
          ]
        },

        d7: {
          chips: ["üèùÔ∏è CocoCay (7:00‚Äì5:00)", "‚ú® Starburst 7:15", "üçΩÔ∏è Dinner after Starburst"],
          events: [
            { start:"07:00", end:"17:00", title:"üèùÔ∏è Perfect Day at CocoCay", category:"port" },
            { start:"19:15", end:"20:05", title:"‚ú® Starburst: Elemental Beauty", venue:"Absolute Zero (D6 Aft)", tags:["locked"], category:"entertainment" },
            { start:"20:15", end:null, grid_mins:60, title:"üçΩÔ∏è Dinner (placeholder after Starburst)", tags:["flex"], category:"dining" },
            { start:"22:30", end:"23:25", title:"üé§ Adult Comedy (18+)", venue:"Royal Theater (D4 Fwd)", category:"entertainment" }
          ]
        }
      }
    };

    /*****************************************************************
     * FILTERS (defaults tuned for usefulness)
     *****************************************************************/
    const FILTER_STATE = {
      port: true,
      excursion: true,
      entertainment: true,
      logistics: true,
      dining: true,        // show dining in Today and day cards
      showWarnings: true,  // overlaps + tight turns
      showRiskTags: true   // show/hide Risk bubble
    };

    /*********************
     * Helpers
     *********************/
    const pad2 = n => String(n).padStart(2,"0");

    function toMin(hhmm){
      if(hhmm == null) return null;
      if(hhmm === "DINING") return null;
      const [h,m] = hhmm.split(":").map(Number);
      return h*60 + m;
    }
    function fmtTime(hhmm){
      if(hhmm == null) return "‚Äî";
      const [h,m] = hhmm.split(":").map(Number);
      if(h === 24 && m === 0) return "12:00a";
      const ampm = h >= 12 ? "p" : "a";
      const hh = ((h + 11) % 12) + 1;
      return `${hh}:${pad2(m)}${ampm}`;
    }
    function fmtRange(start,end){
      if(end == null) return `${fmtTime(start)}‚Äì?`;
      return `${fmtTime(start)}‚Äì${fmtTime(end)}`;
    }

    function tagLabel(tag){
      if(tag==="locked") return "Booked";
      if(tag==="flex") return "Flexible";
      if(tag==="priority") return "Priority";
      if(tag==="risk") return "Risk";
      return tag;
    }

    function renderTagPills(tags){
      if(!tags || !tags.length) return "";
      const filtered = tags.filter(t => FILTER_STATE.showRiskTags ? true : (t !== "risk"));
      if(!filtered.length) return "";
      return `<div class="eventtags">${filtered.map(t => `<span class="tagpill ${t}">${tagLabel(t)}</span>`).join("")}</div>`;
    }

    function isCategoryVisible(cat){
      if(cat === "dining") return FILTER_STATE.dining;
      if(cat === "port") return FILTER_STATE.port;
      if(cat === "excursion") return FILTER_STATE.excursion;
      if(cat === "entertainment") return FILTER_STATE.entertainment;
      if(cat === "logistics") return FILTER_STATE.logistics;
      return true;
    }

    function parseDeck(venue){
      if(!venue) return null;
      const m1 = venue.match(/\(D(\d+)\b/i);
      if(m1) return Number(m1[1]);
      const m2 = venue.match(/\bDeck\s*(\d+)\b/i);
      if(m2) return Number(m2[1]);
      return null;
    }
    function estEndMin(ev){
      const s = toMin(ev.start);
      if(s == null) return null;
      const e = toMin(ev.end);
      if(e != null) return e;
      const mins = Number(ev.grid_mins ?? 75);
      return s + mins;
    }
    function minToHHMM(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return `${pad2(h)}:${pad2(m)}`;
    }
    function minToHHMMCap(min){
      if(min >= 24*60) return "24:00";
      return minToHHMM(min);
    }

    /*********************
     * Warnings: overlaps + tight turns (same as before)
     *********************/
    function computeWarningsForDay(dayId){
      const events = (CRUISE_DATA.days[dayId]?.events || []).map((ev, idx) => ({...ev, _idx: idx}));
      const spans = events
        .map(ev => ({
          idx: ev._idx,
          title: ev.title,
          start: toMin(ev.start),
          end: estEndMin(ev),
          venue: ev.venue || null
        }))
        .filter(s => s.start != null && s.end != null);

      const warningsByIdx = new Map();
      const addWarn = (i, msg) => {
        if(!warningsByIdx.has(i)) warningsByIdx.set(i, []);
        warningsByIdx.get(i).push(msg);
      };

      for(let i=0;i<spans.length;i++){
        for(let j=i+1;j<spans.length;j++){
          const a = spans[i], b = spans[j];
          const overlap = Math.min(a.end, b.end) - Math.max(a.start, b.start);
          if(overlap > 0){
            addWarn(a.idx, `Overlaps with ${b.title} (${fmtRange(minToHHMM(b.start), minToHHMMCap(b.end))})`);
            addWarn(b.idx, `Overlaps with ${a.title} (${fmtRange(minToHHMM(a.start), minToHHMMCap(a.end))})`);
          }
        }
      }

      const sorted = spans.slice().sort((a,b)=>a.start-b.start);
      for(let i=0;i<sorted.length-1;i++){
        const cur = sorted[i], nxt = sorted[i+1];
        const gap = nxt.start - cur.end;
        if(gap < 0) continue;
        const d1 = parseDeck(cur.venue);
        const d2 = parseDeck(nxt.venue);
        if(d1 == null || d2 == null) continue;

        const diff = Math.abs(d2 - d1);
        const needed = (diff <= 1) ? 5 : (diff <= 4) ? 10 : 15;
        if(gap < needed){
          addWarn(nxt.idx, `Tight turn: ~${gap} min gap; suggested ~${needed} min (Deck ${d1} ‚Üí Deck ${d2}).`);
        }
      }
      return warningsByIdx;
    }

    /*********************
     * Grid placement: by start time (but with grid-specific category rules)
     *********************/
    function startInSlot(slot, ev){
      if(slot.start === "DINING") return false;
      const s = toMin(ev.start);
      if(s == null) return false;
      const slotStart = toMin(slot.start);
      const slotEnd = (slot.end == null) ? (24*60 + 240) : toMin(slot.end);
      return (s >= slotStart) && (s < slotEnd);
    }

    function renderEventLine(ev, warningsForThisEvent = []){
      const time = fmtRange(ev.start, ev.end);
      const venue = ev.venue ? `<div class="eventmeta small">${ev.venue}</div>` : "";
      const tags = renderTagPills(ev.tags);
      const warns = (FILTER_STATE.showWarnings && warningsForThisEvent.length)
        ? `<div class="warn">${warningsForThisEvent.map(w => `<div class="warnline">‚ö†Ô∏è ${w}</div>`).join("")}</div>`
        : "";
      return `
        <div class="eventline">
          <div class="eventtitle">
            <strong>${ev.title}</strong>
            <span class="small" style="font-family:var(--mono); color:#cdd6e7">${time}</span>
          </div>
          ${venue}
          ${tags}
          ${warns}
        </div>
      `;
    }

    /*********************
     * Dining Window row: show dining ONCE per day (evening grid)
     *********************/
    function getPrimaryDiningEvent(dayId){
      const evs = (CRUISE_DATA.days[dayId]?.events || []).filter(e => e.category === "dining");
      if(!evs.length) return null;
      evs.sort((a,b)=>(toMin(a.start)??99999)-(toMin(b.start)??99999));
      return evs[0];
    }

    /*********************
     * Render Filters
     *********************/
    function renderFilters(){
      const el = document.getElementById("filters");
      const items = [
        { key:"port", label:"Ports" },
        { key:"excursion", label:"Excursions" },
        { key:"entertainment", label:"Entertainment" },
        { key:"logistics", label:"Logistics" },
        { key:"dining", label:"Dining" },
        { key:"showWarnings", label:"Warnings", sub:"(conflicts + walk time)" },
        { key:"showRiskTags", label:"Risk bubble" }
      ];

      el.innerHTML = items.map(it => `
        <label class="toggle">
          <input type="checkbox" ${FILTER_STATE[it.key] ? "checked" : ""} data-filter="${it.key}" />
          <span>${it.label}</span>
          ${it.sub ? `<small>${it.sub}</small>` : ""}
        </label>
      `).join("");

      el.querySelectorAll("input[data-filter]").forEach(inp => {
        inp.addEventListener("change", () => {
          FILTER_STATE[inp.dataset.filter] = inp.checked;
          rerenderAll();
        });
      });
    }

    /*********************
     * Render Today
     *********************/
    function renderToday(){
      const daybar = document.getElementById("daybar");
      const todayPanel = document.getElementById("todayPanel");
      daybar.innerHTML = "";
      todayPanel.innerHTML = "";

      CRUISE_DATA.meta.days.forEach((d, idx) => {
        const btn = document.createElement("button");
        btn.className = "daybtn" + (idx===0 ? " active" : "");
        btn.dataset.day = d.id;
        btn.textContent = d.label;
        daybar.appendChild(btn);

        const dayObj = CRUISE_DATA.days[d.id];
        const warningsByIdx = computeWarningsForDay(d.id);
        const chips = (dayObj.chips||[]).map(c => `<span class="chip">${c}</span>`).join("");

        const eventsVisible = (dayObj.events||[])
          .filter(ev => isCategoryVisible(ev.category))
          .map((ev, i) => ({ ev, i }));

        const events = eventsVisible.map(({ev, i}) => {
          const warns = warningsByIdx.get(i) || [];
          return `
            <li class="li">
              <div class="when">${fmtRange(ev.start, ev.end)}</div>
              <div class="what">
                ${ev.title}
                ${ev.venue ? `<div class="small">${ev.venue}</div>` : ""}
                ${renderTagPills(ev.tags)}
                ${(FILTER_STATE.showWarnings && warns.length) ? `<div class="warn">${warns.map(w => `<div class="warnline">‚ö†Ô∏è ${w}</div>`).join("")}</div>` : ""}
              </div>
            </li>
          `;
        }).join("");

        const panel = document.createElement("div");
        panel.className = "daypanel" + (idx===0 ? " active" : "");
        panel.id = d.id;
        panel.innerHTML = `
          <div class="kv">${chips}</div>
          <ul class="list">${events || `<li class="li"><div class="what muted">Nothing showing with current filters.</div></li>`}</ul>
        `;
        todayPanel.appendChild(panel);
      });

      const buttons = Array.from(document.querySelectorAll(".daybtn"));
      const panels = Array.from(document.querySelectorAll(".daypanel"));
      function setDay(id){
        buttons.forEach(b => b.classList.toggle("active", b.dataset.day === id));
        panels.forEach(p => p.classList.toggle("active", p.id === id));
        history.replaceState(null, "", "#today");
      }
      buttons.forEach(b => b.addEventListener("click", () => setDay(b.dataset.day)));
    }

    /*********************
     * Render Grids (A: Two grids, no at-a-glance duplication)
     *********************/
    function renderGrid(targetId, slots, mode){
      const wrap = document.getElementById(targetId);
      const days = CRUISE_DATA.meta.days;

      const thead = `
        <thead>
          <tr>
            <th>Time Block</th>
            ${days.map(d => `
              <th>
                <div class="colhead-title">${d.label}</div>
                <div class="colhead-sub">${d.title}</div>
              </th>
            `).join("")}
          </tr>
        </thead>
      `;

      const warningsByDay = {};
      days.forEach(d => warningsByDay[d.id] = computeWarningsForDay(d.id));

      const rows = slots.map(slot => {
        const tds = days.map(d => {
          const all = (CRUISE_DATA.days[d.id]?.events || []);
          const dayEvents = CRUISE_DATA.days[d.id].events;
          const wmap = warningsByDay[d.id];

          // Special dining window row (evening grid only)
          if(slot.start === "DINING"){
            if(!FILTER_STATE.dining) return `<td class="cell-muted">‚Äî</td>`;
            const dine = getPrimaryDiningEvent(d.id);
            if(!dine) return `<td class="cell-muted">‚Äî</td>`;
            const idx = dayEvents.indexOf(dine);
            const warns = (idx >= 0) ? (wmap.get(idx) || []) : [];
            return `<td>${renderEventLine(dine, warns)}</td>`;
          }

          // Category rules per grid
          const allowedCats = (mode === "morning")
            ? new Set(["port","excursion","logistics"])
            : new Set(["entertainment","logistics"]); // evening grid shows entertainment (+ any show buffers if you add them)

          const events = all
            .filter(ev => allowedCats.has(ev.category))
            .filter(ev => isCategoryVisible(ev.category))
            .filter(ev => startInSlot(slot, ev))
            .sort((a,b) => (toMin(a.start) ?? 0) - (toMin(b.start) ?? 0));

          if(!events.length) return `<td class="cell-muted">‚Äî</td>`;

          return `<td>${
            events.map(ev => {
              const idx = dayEvents.indexOf(ev);
              const warns = (idx >= 0) ? (wmap.get(idx) || []) : [];
              return renderEventLine(ev, warns);
            }).join("")
          }</td>`;
        }).join("");

        return `<tr><td>${slot.label}</td>${tds}</tr>`;
      }).join("");

      wrap.innerHTML = `<table aria-label="Visual schedule grid">${thead}<tbody>${rows}</tbody></table>`;
    }

    /*********************
     * Render Full day-by-day cards
     *********************/
    function renderAllDays(){
      const el = document.getElementById("allDays");
      const dayCards = CRUISE_DATA.meta.days.map(d => {
        const dayObj = CRUISE_DATA.days[d.id];
        const warningsByIdx = computeWarningsForDay(d.id);
        const chips = (dayObj.chips||[]).map(c => `<span class="chip">${c}</span>`).join("");

        const eventsVisible = (dayObj.events||[])
          .filter(ev => isCategoryVisible(ev.category))
          .map((ev, i) => ({ ev, i }));

        const events = eventsVisible.map(({ev, i}) => {
          const warns = warningsByIdx.get(i) || [];
          return `
            <li class="li">
              <div class="when">${fmtRange(ev.start, ev.end)}</div>
              <div class="what">
                ${ev.title}
                ${ev.venue ? `<div class="small">${ev.venue}</div>` : ""}
                ${renderTagPills(ev.tags)}
                ${(FILTER_STATE.showWarnings && warns.length) ? `<div class="warn">${warns.map(w => `<div class="warnline">‚ö†Ô∏è ${w}</div>`).join("")}</div>` : ""}
              </div>
            </li>
          `;
        }).join("");

        return `
          <div class="card">
            <h3>${d.label} ‚Äì ${d.title}</h3>
            <div class="kv">${chips}</div>
            <ul class="list">${events || `<li class="li"><div class="what muted">Nothing showing with current filters.</div></li>`}</ul>
          </div>
        `;
      }).join("");

      el.innerHTML = dayCards;
    }

    function rerenderAll(){
      renderFilters();
      renderToday();
      renderGrid("gridTableMorning", CRUISE_DATA.gridSlotsMorning, "morning");
      renderGrid("gridTableEvening", CRUISE_DATA.gridSlotsEvening, "evening");
      renderAllDays();
    }

    function boot(){
      document.getElementById("subtitle").textContent = CRUISE_DATA.meta.subtitle || "";
      rerenderAll();
    }
    boot();
  </script>
</body>
</html>
