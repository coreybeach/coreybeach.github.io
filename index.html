<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cruise Master Plan</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101a2e;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#a6b0c3;
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 600px at 80% 0%, rgba(52,211,153,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.72);
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto; padding:12px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand .title{font-weight:800; letter-spacing:.2px}
    .brand .sub{color:var(--muted); font-size:12px}
    .nav{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .pilllink{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,46,.65);
      font-size:13px;
      transition:.15s transform ease, .15s background ease;
      white-space:nowrap;
      color:inherit; text-decoration:none;
    }
    .pilllink:hover{background: rgba(16,26,46,.9)}
    .pilllink:active{transform:scale(.98)}
    .pilllink.accent{border-color: rgba(96,165,250,.35)}

    .wrap{max-width:1100px; margin:0 auto; padding:16px 14px 70px;}
    section{margin-top:18px}
    .section-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin:8px 0 10px;
    }
    h2{margin:0; font-size:18px; letter-spacing:.2px}
    .note{color:var(--muted); font-size:12px}

    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media (min-width: 860px){ .grid.two{grid-template-columns: 1fr 1fr} }

    .card{
      background: linear-gradient(180deg, rgba(16,26,46,.92), rgba(15,23,42,.92));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
    }
    .card h3{margin:0 0 8px; font-size:15px;}
    .kv{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px;}
    .chip{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }

    /* Filters */
    .filters{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(16,26,46,.65);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .toggle input{accent-color:#60a5fa}
    .toggle small{color:var(--muted)}

    .list{margin:10px 0 0; padding:0; list-style:none; display:flex; flex-direction:column; gap:8px;}
    .li{padding:10px 10px; border-radius: 12px; background: rgba(255,255,255,.03); border:1px solid var(--border);}
    .li .when{font-family:var(--mono); color:#cdd6e7; font-size:12px}
    .li .what{margin-top:2px}
    .muted{color:var(--muted)}
    .small{font-size:12px; color: var(--muted)}
    .warn{margin-top:8px; display:flex; flex-direction:column; gap:6px}
    .warnline{
      font-size:12px;
      color:#fca5a5;
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.25);
      border-radius: 10px;
      padding:6px 8px;
    }

    /* Day selector */
    .daybar{
      display:flex; gap:8px; overflow:auto; padding-bottom:6px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .daybar::-webkit-scrollbar{display:none}
    .daybtn{
      flex: 0 0 auto;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(16,26,46,.75);
      color: #ffffff;
      font-weight: 800;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      transition:
        background .15s ease,
        transform .15s ease,
        color .15s ease,
        box-shadow .15s ease;
    }
    .daybtn:hover{background: rgba(16,26,46,.95); color:#fff;}
    .daybtn:active{transform: scale(.97);}
    .daybtn.active{
      color: #ffffff;
      background: linear-gradient(180deg, rgba(96,165,250,.35), rgba(59,130,246,.35));
      border-color: rgba(96,165,250,.6);
      box-shadow: 0 0 0 2px rgba(96,165,250,.25) inset;
    }
    .daypanel{display:none}
    .daypanel.active{display:block}

    /* Tag pills ‚Äì Priority = RED (you asked) */
    .eventtags{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
    .tagpill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      white-space:nowrap;
      font-weight:800;
    }
    .tagpill.locked{
      background: rgba(16,185,129,.18);
      color: #10b981;
      border: 1px solid rgba(16,185,129,.35);
    }
    .tagpill.flex{
      background: rgba(245,158,11,.20);
      color: #f59e0b;
      border: 1px solid rgba(245,158,11,.35);
    }
    .tagpill.priority{
      background: rgba(239,68,68,.18);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,.35);
    }
    .tagpill.risk{
      background: rgba(244,63,94,.18);
      color: #fb7185;
      border: 1px solid rgba(244,63,94,.35);
    }

    /* Grid tables */
    .table-wrap{
      overflow:auto;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(16,26,46,.55);
      margin-bottom:12px;
    }
    table{ width:100%; border-collapse:collapse; min-width:980px; }
    th, td{
      border-bottom:1px solid var(--border);
      border-right:1px solid var(--border);
      padding:10px 10px;
      vertical-align: top;
      font-size:13px;
    }
    th{
      position:sticky; top:0;
      background: rgba(11,18,32,.95);
      z-index:1;
      text-align:left;
      font-size:12px;
      letter-spacing:.2px;
      color: var(--muted);
    }
    td:first-child, th:first-child{
      position:sticky; left:0;
      background: rgba(11,18,32,.95);
      z-index:2;
      font-family: var(--mono);
      font-size:12px;
      color:#cdd6e7;
      width:140px;
    }
    tr:last-child td{border-bottom:none}
    td:last-child, th:last-child{border-right:none}

    .colhead-title{font-weight:800; color:#e5e7eb; font-size:13px; margin-bottom:4px}
    .colhead-sub{font-size:12px; color:var(--muted)}
    .colhead-summary{
      margin-top:8px;
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .mini{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:#dbe3f3;
      white-space:nowrap;
    }
    .mini.booked{border-color: rgba(16,185,129,.35); background: rgba(16,185,129,.12); color:#7dffcf}
    .mini.flex{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); color:#ffd68a}
    .mini.priority{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); color:#ff9b9b}

    /* Dining band in header (always visible, even if dining hidden in grid) */
    .band{
      margin-top:8px;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:#dbe3f3;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    td .eventline{margin:0 0 12px}
    td .eventline:last-child{margin-bottom:0}
    td .eventtitle{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    td .eventtitle strong{font-weight:750}
    td .eventmeta{margin-top:3px}
    .cell-muted{color: var(--muted)}

    .footer{margin-top:18px; color: var(--muted); font-size:12px; text-align:center;}
    .codehint{
      font-family: var(--mono);
      font-size:12px;
      color: var(--muted);
      white-space:pre-wrap;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: 12px;
      padding:10px;
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="title">üõ≥Ô∏è Cruise Master Plan</div>
        <div class="sub" id="subtitle">All times = ship time ‚Ä¢ Offline-friendly</div>
      </div>
      <nav class="nav">
        <a class="pilllink accent" href="#today">Today</a>
        <a class="pilllink" href="#glance">At-a-glance</a>
        <a class="pilllink" href="#grid">Visual grids</a>
        <a class="pilllink" href="#days">Days</a>
        <a class="pilllink" href="#edit">Edit tips</a>
      </nav>
    </div>
  </div>

  <div class="wrap">
    <section id="today">
      <div class="section-head">
        <h2>üìå Today (tap a day below)</h2>
        <div class="note">Filters apply everywhere.</div>
      </div>

      <div class="card">
        <div class="daybar" id="daybar"></div>

        <div class="filters" id="filters"></div>

        <div class="timeline" id="todayPanel"></div>
      </div>
    </section>

    <section id="glance">
      <div class="section-head">
        <h2>üëÄ At-a-glance</h2>
        <div class="note">Fast decisions without scrolling.</div>
      </div>

      <div class="grid two" id="glanceTop"></div>
      <div class="grid two" style="margin-top:12px" id="glanceBottom"></div>
    </section>

    <section id="grid">
      <div class="section-head">
        <h2>üóìÔ∏è Visual grids</h2>
        <div class="note">Morning/Port + Evening/Shows ‚Ä¢ standardized blocks ‚Ä¢ single-placement by start time.</div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:10px;">üåÖ Morning / Port grid</h3>
        <div class="table-wrap" id="gridTableMorning"></div>

        <h3 style="margin:14px 0 10px;">üåô Evening / Shows grid</h3>
        <div class="table-wrap" id="gridTableEvening"></div>
      </div>
    </section>

    <section id="days">
      <div class="section-head">
        <h2>üìÖ Full day-by-day</h2>
        <div class="note">Includes auto conflict + travel buffer warnings.</div>
      </div>
      <div class="grid two" id="allDays"></div>
    </section>

    <section id="edit">
      <div class="section-head">
        <h2>üõ†Ô∏è Easy edits</h2>
        <div class="note">Change only the data block (no HTML/CSS changes needed).</div>
      </div>
      <div class="card">
        <h3>How to edit</h3>
        <div class="codehint">
1) Update times in: days.dX.events[].start/end (24h "HH:MM", use "24:00" for midnight)
2) Categories: "port" | "excursion" | "dining" | "entertainment" | "logistics"
3) Tags: ["locked"] (Booked) / ["flex"] (Flexible) / ["priority"] (RED) / ["risk"]
4) For open-ended items, set end:null and optionally grid_mins (default 75)
5) Dining in grid: controlled by the "Dining in grids" filter (default OFF); dining still shows in Today + At-a-glance header band.
        </div>
      </div>
    </section>

    <div class="footer">
      iPhone Safari ‚Üí Share ‚Üí ‚ÄúAdd to Home Screen‚Äù. Android Chrome ‚Üí Menu ‚Üí ‚ÄúAdd to Home screen‚Äù.
    </div>
  </div>

  <script>
    /*****************************************************************
     * EDIT HERE: CRUISE_DATA
     *****************************************************************/
    const CRUISE_DATA = {
      meta: {
        subtitle: "All times = ship time ‚Ä¢ Offline-friendly",
        days: [
          { id:"d1", label:"Day 1", title:"Miami / Sail Away" },
          { id:"d2", label:"Day 2", title:"Sea Day" },
          { id:"d3", label:"Day 3", title:"Puerto Costa Maya (8:00‚Äì5:00)" },
          { id:"d4", label:"Day 4", title:"Roat√°n (7:00‚Äì4:00)" },
          { id:"d5", label:"Day 5", title:"Cozumel (8:00‚Äì6:00)" },
          { id:"d6", label:"Day 6", title:"Sea Day" },
          { id:"d7", label:"Day 7", title:"CocoCay (7:00‚Äì5:00)" }
        ]
      },

      // Standardized blocks (morning + evening)
      gridSlotsMorning: [
        { label:"7:00‚Äì8:30",   start:"07:00", end:"08:30" },
        { label:"8:30‚Äì10:00",  start:"08:30", end:"10:00" },
        { label:"10:00‚Äì11:30", start:"10:00", end:"11:30" },
        { label:"11:30‚Äì1:00",  start:"11:30", end:"13:00" },
        { label:"1:00‚Äì3:00",   start:"13:00", end:"15:00" },
        { label:"3:00‚Äì4:30",   start:"15:00", end:"16:30" }
      ],
      gridSlotsEvening: [
        { label:"4:30‚Äì6:00",   start:"16:30", end:"18:00" },
        { label:"6:00‚Äì7:30",   start:"18:00", end:"19:30" },
        { label:"7:30‚Äì9:00",   start:"19:30", end:"21:00" },
        { label:"9:00‚Äì10:30",  start:"21:00", end:"22:30" },
        { label:"10:30‚Äì12:00", start:"22:30", end:"24:00" },
        { label:"12:00‚ÄìLate",  start:"24:00", end:null }
      ],

      glance: {
        dining: [
          { day:"Day 1", text:"üçΩÔ∏è My Time Dining (6:30‚Äì?)", tags:["flex"] },
          { day:"Day 2", text:"üçΩÔ∏è My Time Dining (6:45‚Äì?)", tags:["locked"] },
          { day:"Day 3", text:"üçΩÔ∏è My Time Dining (7:00‚Äì?)", tags:["flex"] },
          { day:"Day 4", text:"üçΩÔ∏è My Time Dining (6:45‚Äì?)", tags:["locked"] },
          { day:"Day 5", text:"üçΩÔ∏è My Time Dining (8:30‚Äì?)", tags:["locked"] },
          { day:"Day 6", text:"üçΩÔ∏è My Time Dining (6:30‚Äì?)", tags:["flex"] },
          { day:"Day 7", text:"üçΩÔ∏è Dinner after Starburst (after ~8:15)", tags:["flex"] }
        ],
        ports: [
          { day:"Day 3", text:"Puerto Costa Maya (8:00‚Äì5:00) ‚Äî Explore" },
          { day:"Day 4", text:"Roat√°n (7:00‚Äì4:00) ‚Äî Zipline 9:00 (meet ~8:30)" },
          { day:"Day 5", text:"Cozumel (8:00‚Äì6:00) ‚Äî ATV + Jade Caverns 10:00 (ready ~9:30)" },
          { day:"Day 7", text:"CocoCay (7:00‚Äì5:00) ‚Äî Chill day" }
        ],
        entertainment: [
          { day:"Day 1", text:"Headliner (9:30‚Äì10:20) ‚Ä¢ Sing-Along (11:50‚Äì12:00) ‚Ä¢ Balloon Drop/DJ (12:00‚ÄìLate)" },
          { day:"Day 2", text:"Adult Comedy (11:30‚Äì12:25)" },
          { day:"Day 3", text:"Wizard of Oz (4:30‚Äì6:10) ‚Ä¢ Adult Comedy (11:30‚Äì12:25)" },
          { day:"Day 4", text:"Game Show: Love & Marriage (9:00‚Äì10:00)", tags:["priority"] },
          { day:"Day 5", text:"Price Is Right (7:00‚Äì8:00) ‚Ä¢ Crazy Quest (11:00‚Äì11:45)", tags:["priority"] },
          { day:"Day 6", text:"Aqua Action (10:30‚Äì11:30)", tags:["locked"] },
          { day:"Day 7", text:"Starburst (7:15‚Äì8:05) ‚Ä¢ Adult Comedy (10:30‚Äì11:25)" }
        ],
        risk: [
          { label:"Early mornings", text:"Day 4 (Zipline) ‚Ä¢ Day 5 (ATV)" },
          { label:"Late-night risk", text:"Day 1 (past midnight) ‚Ä¢ Day 3 (comedy ends 12:25 ‚Üí early excursion)", tags:["risk"] },
          { label:"High-energy days", text:"Day 4 ‚Ä¢ Day 5" },
          { label:"Recovery days", text:"Day 2 ‚Ä¢ Day 6 ‚Ä¢ Day 7 (choose chill)" },
          { label:"Best nights to book more", text:"Day 2 ‚Ä¢ Day 6 (Sea Days)" }
        ],
        logistics: [
          { label:"Arrive early rule", text:"Aim to be seated ~10‚Äì15 min before shows; meet buffers ~30 min for excursions." },
          { label:"Venue quick map", text:"Royal Theater (Deck 4 Fwd) ‚Ä¢ The Attic (Deck 6 Fwd) ‚Ä¢ Absolute Zero (Deck 6 Aft) ‚Ä¢ AquaTheater (Deck 15 Fwd) ‚Ä¢ Promenade (Deck 5 Mid) ‚Ä¢ Music Hall (Deck 3 Fwd)" },
          { label:"Safety briefing", text:"Complete mandatory guest safety briefing on Day 1.", tags:["priority"] },
          { label:"Ship time", text:"All times shown are Ship Time." }
        ]
      },

      days: {
        d1: {
          chips: ["üìç Miami ‚Üí Sail Away", "üçΩÔ∏è Dining flexible", "üßØ Safety briefing required"],
          events: [
            { start:"16:30", end:"17:00", title:"üéâ Sail Away Party", venue:"Pool Deck (D16)", category:"entertainment" },
            { start:"18:30", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["flex"], category:"dining" },
            { start:"21:30", end:"22:20", title:"üé≠ Headliner", venue:"Royal Theater (D4 Fwd)", category:"entertainment" },
            { start:"23:50", end:"24:00", title:"üé∂ Big Welcome Sing-Along", venue:"Royal Promenade (D5 Mid)", category:"entertainment" },
            { start:"24:00", end:null, grid_mins:90, title:"üéâ Balloon Drop + After Hours DJ", venue:"Promenade (D5 Mid) / Music Hall (D3 Fwd)", category:"entertainment" }
          ]
        },

        d2: {
          chips: ["üåä Sea Day", "üçΩÔ∏è Booked dining"],
          events: [
            { start:"18:45", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["locked"], category:"dining" },
            { start:"23:30", end:"24:25", title:"üé§ Adult Comedy (18+)", venue:"The Attic (D6 Fwd)", category:"entertainment" }
          ]
        },

        d3: {
          chips: ["üèùÔ∏è Puerto Costa Maya (8:00‚Äì5:00)", "üçΩÔ∏è Dining shifted", "‚ö†Ô∏è Late night risk"],
          events: [
            { start:"08:00", end:"17:00", title:"üèùÔ∏è Port day (explore)", category:"port" },
            { start:"16:30", end:"18:10", title:"üé≠ The Wizard of Oz", venue:"Royal Theater (D4 Fwd)", category:"entertainment" },
            { start:"19:00", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["flex"], category:"dining" },
            { start:"23:30", end:"24:25", title:"üé§ Adult Comedy (18+)", venue:"The Attic (D6 Fwd)", tags:["risk"], category:"entertainment" }
          ]
        },

        d4: {
          chips: ["üèùÔ∏è Roat√°n (7:00‚Äì4:00)", "üßó Zipline 9:00 (meet ~8:30)", "üçΩÔ∏è Booked dining"],
          events: [
            { start:"08:30", end:null, grid_mins:30, title:"‚è±Ô∏è Meet buffer (excursion)", tags:["priority"], category:"logistics" },
            { start:"09:00", end:null, grid_mins:180, title:"üßó Zip & Dip (Excursion)", venue:"Port of Roat√°n", tags:["priority"], category:"excursion" },
            { start:"18:45", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["locked"], category:"dining" },
            { start:"21:00", end:"22:00", title:"üéÆ Game Show: Love & Marriage", venue:"Royal Theater (D4 Fwd)", tags:["priority"], category:"entertainment" }
          ]
        },

        d5: {
          chips: ["üèùÔ∏è Cozumel (8:00‚Äì6:00)", "üõû ATV 10:00 (ready ~9:30)", "üçΩÔ∏è Booked dining 8:30"],
          events: [
            { start:"09:30", end:null, grid_mins:30, title:"‚è±Ô∏è Ready buffer (excursion)", tags:["priority"], category:"logistics" },
            { start:"10:00", end:null, grid_mins:240, title:"üõû ATV Ride to Jade Caverns (Excursion)", venue:"Cozumel", tags:["priority"], category:"excursion" },
            { start:"19:00", end:"20:00", title:"üéÆ Price Is Right ‚Äì Everyone‚Äôs a Contestant", venue:"Royal Theater (D4 Fwd)", tags:["priority"], category:"entertainment" },
            { start:"20:30", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["locked"], category:"dining" },
            { start:"23:00", end:"23:45", title:"üéÆ The Crazy Quest (18+)", venue:"Absolute Zero (D6 Aft)", tags:["priority"], category:"entertainment" }
          ]
        },

        d6: {
          chips: ["üåä Sea Day", "üçΩÔ∏è Dining flexible", "üí¶ Aqua Action booked"],
          events: [
            { start:"18:30", end:null, grid_mins:75, title:"üçΩÔ∏è My Time Dining", tags:["flex"], category:"dining" },
            { start:"22:30", end:"23:30", title:"üí¶ AQUA ACTION!", venue:"AquaTheater (D15 Fwd)", tags:["locked"], category:"entertainment" }
          ]
        },

        d7: {
          chips: ["üèùÔ∏è CocoCay (7:00‚Äì5:00)", "‚ú® Starburst 7:15", "üçΩÔ∏è Dinner after Starburst"],
          events: [
            { start:"07:00", end:"17:00", title:"üèùÔ∏è Perfect Day at CocoCay", category:"port" },
            { start:"19:15", end:"20:05", title:"‚ú® Starburst: Elemental Beauty", venue:"Absolute Zero (D6 Aft)", tags:["locked"], category:"entertainment" },
            { start:"20:15", end:null, grid_mins:60, title:"üçΩÔ∏è Dinner (placeholder after Starburst)", tags:["flex"], category:"dining" },
            { start:"22:30", end:"23:25", title:"üé§ Adult Comedy (18+)", venue:"Royal Theater (D4 Fwd)", category:"entertainment" }
          ]
        }
      },

      debark: {
        when:"Jan 31 ‚Ä¢ 6:00 AM",
        text:"üß≥ Arrive Miami ‚Äî plan bags/exit timing accordingly"
      }
    };

    /*****************************************************************
     * FILTERS (you can change defaults here)
     *****************************************************************/
    const FILTER_STATE = {
      port: true,
      excursion: true,
      entertainment: true,
      logistics: true,
      dining: true,        // shows dining in Today + Day cards
      diningInGrid: false, // KEY: hide dining events in grids (band still shows)
      showWarnings: true,  // conflict + travel buffer warnings
      showRiskTags: true   // hide/show the "Risk" bubble itself
    };

    /*********************
     * Helpers
     *********************/
    const pad2 = n => String(n).padStart(2,"0");

    function toMin(hhmm){
      if(hhmm == null) return null;
      const [h,m] = hhmm.split(":").map(Number);
      return h*60 + m;
    }
    function fmtTime(hhmm){
      if(hhmm == null) return "‚Äî";
      const [h,m] = hhmm.split(":").map(Number);
      if(h === 24 && m === 0) return "12:00a";
      const ampm = h >= 12 ? "p" : "a";
      const hh = ((h + 11) % 12) + 1;
      return `${hh}:${pad2(m)}${ampm}`;
    }
    function fmtRange(start,end){
      if(end == null) return `${fmtTime(start)}‚Äì?`;
      return `${fmtTime(start)}‚Äì${fmtTime(end)}`;
    }

    function tagLabel(tag){
      if(tag==="locked") return "Booked";
      if(tag==="flex") return "Flexible";
      if(tag==="priority") return "Priority";
      if(tag==="risk") return "Risk";
      return tag;
    }

    function renderTagPills(tags){
      if(!tags || !tags.length) return "";
      const filtered = tags.filter(t => FILTER_STATE.showRiskTags ? true : (t !== "risk"));
      if(!filtered.length) return "";
      return `<div class="eventtags">${filtered.map(t => `<span class="tagpill ${t}">${tagLabel(t)}</span>`).join("")}</div>`;
    }

    function renderEventLine(ev, warningsForThisEvent = []){
      const time = fmtRange(ev.start, ev.end);
      const venue = ev.venue ? `<div class="eventmeta small">${ev.venue}</div>` : "";
      const tags = renderTagPills(ev.tags);
      const warns = (FILTER_STATE.showWarnings && warningsForThisEvent.length)
        ? `<div class="warn">${warningsForThisEvent.map(w => `<div class="warnline">‚ö†Ô∏è ${w}</div>`).join("")}</div>`
        : "";
      return `
        <div class="eventline">
          <div class="eventtitle">
            <strong>${ev.title}</strong>
            <span class="small" style="font-family:var(--mono); color:#cdd6e7">${time}</span>
          </div>
          ${venue}
          ${tags}
          ${warns}
        </div>
      `;
    }

    function isCategoryVisible(cat){
      if(cat === "dining") return FILTER_STATE.dining;
      if(cat === "port") return FILTER_STATE.port;
      if(cat === "excursion") return FILTER_STATE.excursion;
      if(cat === "entertainment") return FILTER_STATE.entertainment;
      if(cat === "logistics") return FILTER_STATE.logistics;
      return true;
    }

    function isVisibleInGrid(ev){
      if(ev.category === "dining" && !FILTER_STATE.diningInGrid) return false;
      return isCategoryVisible(ev.category);
    }

    /* Parse deck number from venue text like (D15 ...) or "Deck 4" if present */
    function parseDeck(venue){
      if(!venue) return null;
      const m1 = venue.match(/\(D(\d+)\b/i);
      if(m1) return Number(m1[1]);
      const m2 = venue.match(/\bDeck\s*(\d+)\b/i);
      if(m2) return Number(m2[1]);
      return null;
    }

    function estEndMin(ev){
      const s = toMin(ev.start);
      if(s == null) return null;
      const e = toMin(ev.end);
      if(e != null) return e;
      const mins = Number(ev.grid_mins ?? 75);
      return s + mins;
    }

    /*********************
     * Conflict + Travel buffer warnings
     *********************/
    function computeWarningsForDay(dayId){
      const events = (CRUISE_DATA.days[dayId]?.events || []).map((ev, idx) => ({...ev, _idx: idx}));
      // Only warn on visible categories (except: keep warnings about hidden dining if it conflicts with visible entertainment)
      // We'll compute conflicts across all events, then decide which to display per visible event.
      const spans = events
        .map(ev => ({
          idx: ev._idx,
          title: ev.title,
          cat: ev.category,
          start: toMin(ev.start),
          end: estEndMin(ev),
          venue: ev.venue || null
        }))
        .filter(s => s.start != null && s.end != null);

      const warningsByIdx = new Map();
      const addWarn = (i, msg) => {
        if(!warningsByIdx.has(i)) warningsByIdx.set(i, []);
        warningsByIdx.get(i).push(msg);
      };

      // Overlap detection
      for(let i=0;i<spans.length;i++){
        for(let j=i+1;j<spans.length;j++){
          const a = spans[i], b = spans[j];
          const overlap = Math.min(a.end, b.end) - Math.max(a.start, b.start);
          if(overlap > 0){
            addWarn(a.idx, `Overlaps with ${b.title} (${fmtRange(minToHHMM(b.start), minToHHMMCap(b.end))})`);
            addWarn(b.idx, `Overlaps with ${a.title} (${fmtRange(minToHHMM(a.start), minToHHMMCap(a.end))})`);
          }
        }
      }

      // Travel buffer between consecutive events (same day)
      const sorted = spans.slice().sort((a,b)=>a.start-b.start);
      for(let i=0;i<sorted.length-1;i++){
        const cur = sorted[i], nxt = sorted[i+1];
        // If there is a time gap and both have venues/decks, check if gap is tight
        const gap = nxt.start - cur.end;
        if(gap < 0) continue; // already overlap handled
        const d1 = parseDeck(cur.venue);
        const d2 = parseDeck(nxt.venue);
        if(d1 == null || d2 == null) continue;

        const diff = Math.abs(d2 - d1);
        const needed = (diff <= 1) ? 5 : (diff <= 4) ? 10 : 15;
        if(gap < needed){
          addWarn(nxt.idx, `Tight turn: ~${gap} min gap; suggested ~${needed} min between venues (Deck ${d1} ‚Üí Deck ${d2}).`);
        }
      }

      return warningsByIdx;
    }

    function minToHHMM(min){
      const h = Math.floor(min/60);
      const m = min%60;
      return `${pad2(h)}:${pad2(m)}`;
    }
    function minToHHMMCap(min){
      // allow beyond 24:00 for estimates but cap display at 24:00+
      if(min >= 24*60) return "24:00";
      return minToHHMM(min);
    }

    /*********************
     * Dining band + day summary
     *********************/
    function getDiningBand(dayId){
      const evs = (CRUISE_DATA.days[dayId]?.events || []).filter(ev => ev.category==="dining");
      if(!evs.length) return null;
      // pick earliest dining start
      evs.sort((a,b)=>(toMin(a.start)??99999)-(toMin(b.start)??99999));
      const d = evs[0];
      const time = fmtRange(d.start, d.end);
      const status = (d.tags||[]).includes("locked") ? "Booked" : (d.tags||[]).includes("flex") ? "Flexible" : "";
      const cls = (d.tags||[]).includes("locked") ? "booked" : (d.tags||[]).includes("flex") ? "flex" : "";
      return { text:`üçΩÔ∏è Dining: ${time}`, status, cls };
    }

    function getDaySummaryBadges(dayId){
      const evs = (CRUISE_DATA.days[dayId]?.events || []);
      const badges = [];

      // Dining badge (always)
      const dining = getDiningBand(dayId);
      if(dining){
        badges.push({ text: dining.text.replace("üçΩÔ∏è ","üçΩÔ∏è "), cls: dining.cls || "flex" });
      }

      // Excursion badge (first excursion / ready buffer)
      const ex = evs
        .filter(e => (e.category==="excursion" || (e.category==="logistics" && /buffer/i.test(e.title))) )
        .sort((a,b)=>(toMin(a.start)??99999)-(toMin(b.start)??99999))[0];
      if(ex){
        badges.push({ text:`üß≠ ${fmtTime(ex.start)}`, cls:"" });
      }

      // Priority entertainment badge (first priority entertainment)
      const pr = evs
        .filter(e => e.category==="entertainment" && (e.tags||[]).includes("priority"))
        .sort((a,b)=>(toMin(a.start)??99999)-(toMin(b.start)??99999))[0];
      if(pr){
        badges.push({ text:`‚≠ê ${fmtTime(pr.start)}`, cls:"priority" });
      }

      // Late night risk badge (any risk tag)
      const hasRisk = evs.some(e => (e.tags||[]).includes("risk"));
      if(hasRisk){
        badges.push({ text:"‚ö†Ô∏è Risk", cls:"priority" });
      }

      return badges.slice(0,4);
    }

    /*********************
     * Grid placement logic (single-placement by START TIME)
     *********************/
    function startInSlot(slot, ev){
      const s = toMin(ev.start);
      if(s == null) return false;
      const slotStart = toMin(slot.start);
      const slotEnd = (slot.end == null) ? (24*60 + 240) : toMin(slot.end);
      return (s >= slotStart) && (s < slotEnd);
    }

    /*********************
     * UI: Filters
     *********************/
    function renderFilters(){
      const el = document.getElementById("filters");
      const items = [
        { key:"port", label:"Ports" },
        { key:"excursion", label:"Excursions" },
        { key:"entertainment", label:"Entertainment" },
        { key:"logistics", label:"Logistics" },
        { key:"dining", label:"Dining" },
        { key:"diningInGrid", label:"Dining in grids", sub:"(recommended OFF)" },
        { key:"showWarnings", label:"Warnings", sub:"(conflicts + walk time)" },
        { key:"showRiskTags", label:"Risk bubble" }
      ];

      el.innerHTML = items.map(it => `
        <label class="toggle">
          <input type="checkbox" ${FILTER_STATE[it.key] ? "checked" : ""} data-filter="${it.key}" />
          <span>${it.label}</span>
          ${it.sub ? `<small>${it.sub}</small>` : ""}
        </label>
      `).join("");

      el.querySelectorAll("input[data-filter]").forEach(inp => {
        inp.addEventListener("change", () => {
          FILTER_STATE[inp.dataset.filter] = inp.checked;
          rerenderAll();
        });
      });
    }

    /*********************
     * Render: Today
     *********************/
    function renderToday(){
      const daybar = document.getElementById("daybar");
      const todayPanel = document.getElementById("todayPanel");
      daybar.innerHTML = "";
      todayPanel.innerHTML = "";

      CRUISE_DATA.meta.days.forEach((d, idx) => {
        const btn = document.createElement("button");
        btn.className = "daybtn" + (idx===0 ? " active" : "");
        btn.dataset.day = d.id;
        btn.textContent = d.label;
        daybar.appendChild(btn);

        const dayObj = CRUISE_DATA.days[d.id];
        const warningsByIdx = computeWarningsForDay(d.id);
        const chips = (dayObj.chips||[]).map(c => `<span class="chip">${c}</span>`).join("");

        const eventsVisible = (dayObj.events||[])
          .filter(ev => isCategoryVisible(ev.category))
          .map((ev, i) => ({ ev, i }));

        const events = eventsVisible.map(({ev, i}) => {
          const warns = warningsByIdx.get(i) || [];
          return `
            <li class="li">
              <div class="when">${fmtRange(ev.start, ev.end)}</div>
              <div class="what">
                ${ev.title}
                ${ev.venue ? `<div class="small">${ev.venue}</div>` : ""}
                ${renderTagPills(ev.tags)}
                ${(FILTER_STATE.showWarnings && warns.length) ? `<div class="warn">${warns.map(w => `<div class="warnline">‚ö†Ô∏è ${w}</div>`).join("")}</div>` : ""}
              </div>
            </li>
          `;
        }).join("");

        const panel = document.createElement("div");
        panel.className = "daypanel" + (idx===0 ? " active" : "");
        panel.id = d.id;
        panel.innerHTML = `
          <div class="kv">${chips}</div>
          <ul class="list">${events || `<li class="li"><div class="what muted">Nothing showing with current filters.</div></li>`}</ul>
        `;
        todayPanel.appendChild(panel);
      });

      const buttons = Array.from(document.querySelectorAll(".daybtn"));
      const panels = Array.from(document.querySelectorAll(".daypanel"));
      function setDay(id){
        buttons.forEach(b => b.classList.toggle("active", b.dataset.day === id));
        panels.forEach(p => p.classList.toggle("active", p.id === id));
        history.replaceState(null, "", "#today");
      }
      buttons.forEach(b => b.addEventListener("click", () => setDay(b.dataset.day)));
    }

    /*********************
     * Render: At-a-glance (respects filters)
     *********************/
    function renderGlance(){
      const top = document.getElementById("glanceTop");
      const bottom = document.getElementById("glanceBottom");

      const makeList = (items, mode="dayText", catKey=null) => {
        const filtered = catKey ? items.filter(()=>FILTER_STATE[catKey]) : items;
        if(mode==="dayText"){
          return `<ul class="list">${filtered.map(it => `
            <li class="li">
              <div class="when">${it.day}</div>
              <div class="what">
                ${it.text}
                ${renderTagPills(it.tags)}
              </div>
            </li>
          `).join("")}</ul>`;
        }
        return `<ul class="list">${filtered.map(it => `
          <li class="li">
            <div class="when">${it.label}</div>
            <div class="what">
              ${it.text}
              ${renderTagPills(it.tags)}
            </div>
          </li>
        `).join("")}</ul>`;
      };

      top.innerHTML = `
        <div class="card">
          <h3>üé≠ Entertainment</h3>
          ${FILTER_STATE.entertainment ? makeList(CRUISE_DATA.glance.entertainment, "dayText") : `<div class="muted">Hidden by filter.</div>`}
        </div>
        <div class="card">
          <h3>üèùÔ∏è Ports & Excursions</h3>
          ${(FILTER_STATE.port || FILTER_STATE.excursion) ? makeList(CRUISE_DATA.glance.ports, "dayText") : `<div class="muted">Hidden by filter.</div>`}
        </div>
      `;

      bottom.innerHTML = `
        <div class="card">
          <h3>üçΩÔ∏è Dining</h3>
          ${FILTER_STATE.dining ? makeList(CRUISE_DATA.glance.dining, "dayText") : `<div class="muted">Hidden by filter.</div>`}
        </div>
        <div class="card">
          <h3>‚ö†Ô∏è Risk & Energy</h3>
          ${(FILTER_STATE.showWarnings || FILTER_STATE.showRiskTags) ? makeList(CRUISE_DATA.glance.risk, "labelText") : `<div class="muted">Hidden by filter.</div>`}
        </div>
        <div class="card" style="grid-column: 1 / -1;">
          <h3>üß≠ Logistics</h3>
          ${FILTER_STATE.logistics ? makeList(CRUISE_DATA.glance.logistics, "labelText") : `<div class="muted">Hidden by filter.</div>`}
        </div>
      `;
    }

    /*********************
     * Render: Grid (morning + evening)
     *********************/
    function renderGrid(targetId, slots){
      const wrap = document.getElementById(targetId);
      const days = CRUISE_DATA.meta.days;

      const thead = `
        <thead>
          <tr>
            <th>Time Block</th>
            ${days.map(d => {
              const summary = getDaySummaryBadges(d.id);
              const dining = getDiningBand(d.id);
              const band = dining ? `
                <div class="band">
                  <span>${dining.text}</span>
                  <span class="mini ${dining.cls || ""}">${dining.status || (dining.cls==="flex" ? "Flexible" : "")}</span>
                </div>
              ` : ``;

              return `
                <th>
                  <div class="colhead-title">${d.label}</div>
                  <div class="colhead-sub">${d.title}</div>
                  <div class="colhead-summary">
                    ${summary.map(s => `<span class="mini ${s.cls||""}">${s.text}</span>`).join("")}
                  </div>
                  ${band}
                </th>
              `;
            }).join("")}
          </tr>
        </thead>
      `;

      // Precompute warnings for grid display
      const warningsByDay = {};
      days.forEach(d => warningsByDay[d.id] = computeWarningsForDay(d.id));

      const rows = slots.map(slot => {
        const tds = days.map(d => {
          const all = (CRUISE_DATA.days[d.id]?.events || []);
          const events = all
            .filter(ev => isVisibleInGrid(ev))
            .filter(ev => startInSlot(slot, ev))
            .sort((a,b) => (toMin(a.start) ?? 0) - (toMin(b.start) ?? 0));

          if(!events.length) return `<td class="cell-muted">‚Äî</td>`;

          // warnings: map original index
          const dayEvents = CRUISE_DATA.days[d.id].events;
          const wmap = warningsByDay[d.id];

          return `<td>${
            events.map(ev => {
              const idx = dayEvents.indexOf(ev); // same object ref
              const warns = (idx >= 0) ? (wmap.get(idx) || []) : [];
              return renderEventLine(ev, warns);
            }).join("")
          }</td>`;
        }).join("");

        return `<tr><td>${slot.label}</td>${tds}</tr>`;
      }).join("");

      wrap.innerHTML = `<table aria-label="Visual schedule grid">${thead}<tbody>${rows}</tbody></table>`;
    }

    /*********************
     * Render: Full day-by-day cards
     *********************/
    function renderAllDays(){
      const el = document.getElementById("allDays");
      const dayCards = CRUISE_DATA.meta.days.map(d => {
        const dayObj = CRUISE_DATA.days[d.id];
        const warningsByIdx = computeWarningsForDay(d.id);
        const chips = (dayObj.chips||[]).map(c => `<span class="chip">${c}</span>`).join("");

        const eventsVisible = (dayObj.events||[])
          .filter(ev => isCategoryVisible(ev.category))
          .map((ev, i) => ({ ev, i }));

        const events = eventsVisible.map(({ev, i}) => {
          const warns = warningsByIdx.get(i) || [];
          return `
            <li class="li">
              <div class="when">${fmtRange(ev.start, ev.end)}</div>
              <div class="what">
                ${ev.title}
                ${ev.venue ? `<div class="small">${ev.venue}</div>` : ""}
                ${renderTagPills(ev.tags)}
                ${(FILTER_STATE.showWarnings && warns.length) ? `<div class="warn">${warns.map(w => `<div class="warnline">‚ö†Ô∏è ${w}</div>`).join("")}</div>` : ""}
              </div>
            </li>
          `;
        }).join("");

        return `
          <div class="card">
            <h3>${d.label} ‚Äì ${d.title}</h3>
            <div class="kv">${chips}</div>
            <ul class="list">${events || `<li class="li"><div class="what muted">Nothing showing with current filters.</div></li>`}</ul>
          </div>
        `;
      }).join("");

      const debark = `
        <div class="card">
          <h3>üß≥ Debarkation</h3>
          <ul class="list">
            <li class="li">
              <div class="when">${CRUISE_DATA.debark.when}</div>
              <div class="what">${CRUISE_DATA.debark.text}</div>
            </li>
          </ul>
        </div>
      `;

      el.innerHTML = dayCards + debark;
    }

    function rerenderAll(){
      renderFilters();
      renderToday();
      renderGlance();
      renderGrid("gridTableMorning", CRUISE_DATA.gridSlotsMorning);
      renderGrid("gridTableEvening", CRUISE_DATA.gridSlotsEvening);
      renderAllDays();
    }

    function boot(){
      document.getElementById("subtitle").textContent = CRUISE_DATA.meta.subtitle || "";
      rerenderAll();
    }
    boot();
  </script>
</body>
</html>
